<!DOCTYPE html>
<html>
<head>
  <title>Questionnaire</title>
  <script src="https://unpkg.com/jspsych@7.3.4"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.2.0"></script> 
  <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>
  <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css" />
</head>
<body></body>
<script>

// Init jsPsych
const jsPsych = initJsPsych({
  on_finish: function() {
    //jsPsych.data.displayData();
    console.log("Total correct answers:", correct_count);
  }
});

const subject_id = jsPsych.randomization.randomID(10);
const filename = `${subject_id}.csv`;
            

let correct_count = 0;

// Define correct answers separately
const correctAnswers = {
  q1: "3",
  q2: "75",
  q3: "Paris",
  q4: "Intentionally dense?",
  q5: "IHasCupquake",
  q6: "This one",
  q7: "Honk"
};

// Function to add click listeners for per-question RT, accuracy, skipped detection
function addSurveyLogic(trial) {

  trial.on_load = function() {
    // Initialize per-page variables
    window.last_question_time = performance.now();
    window.rt_data = {};
    window.acc_data = {};
    window.answered = {};
    
    trial.questions.forEach(q => {
      window.answered[q.name] = false;
      window.rt_data[q.name] = null;
      window.acc_data[q.name] = null;
    });

    // Add click listeners to all radio buttons
    setTimeout(() => {
      const radios = document.querySelectorAll("input[type='radio']");
      radios.forEach(radio => {
        radio.addEventListener("click", function(event) {
          let now = performance.now();

          // Map the input name to the correct question name
          const qIndex = parseInt(event.target.name.replace("jspsych-survey-multi-choice-response-",""));
          const qname = trial.questions[qIndex].name;
          const response = event.target.value;

          // Store response
          window.answered[qname] = true;
          window.rt_data[qname] = now - window.last_question_time;
          window.last_question_time = now;

          // Check accuracy
          if(correctAnswers[qname] !== undefined){
            if (response === correctAnswers[qname]) {
              window.acc_data[qname] = true;
              correct_count++;
            } else{
              window.acc_data[qname] = false;
            }
          } else {
            window.acc_data[qname] = null;
          }
          }
        );
      }
    );
    }, 100); // slightly longer delay to ensure inputs exist
  };

  trial.on_finish = function(data) {
    // Mark skipped questions
    trial.questions.forEach(q => {
      if(!window.answered[q.name]){
        window.rt_data[q.name] = null;
        window.acc_data[q.name] = null;
      }
    });

    // Save data to trial
    data.rt_per_question = window.rt_data;
    data.accuracy_per_question = window.acc_data;
    data.skipped = {};
    trial.questions.forEach(q => {
      data.skipped[q.name] = !window.answered[q.name];
    });
  };

  return trial;
}

// Define all pages
const intro = {
  type: jsPsychSurveyMultiChoice,
  preamble: `<h2>Welcome to the Experiment</h2><p>4 blocks of 40 MCQs</p>`,
  questions: [{prompt:"Ready to begin?", options:["Yes"], name:"start", required:true}]
};

const page1_qs = {
  type: jsPsychSurveyMultiChoice,
  questions: [
    {prompt: "What is 1 + 2?", name:'q1', options:['1','2','3','4']},
    {prompt: "What is 51 + 24?", name:'q2', options:['72','75','77','74']},
    {prompt: "Capital of France?", name:'q3', options:['London','Bulgaria','Paris','George']}
  ]
};

const page2_qs = {
  type: jsPsychSurveyMultiChoice,
  questions: [
    {prompt: "Huh?", name:'q4', options:['Intentionally dense?','Cucumber','Eggplant','Corn']},
    {prompt: "Who is the best YouTuber?", name:'q5', options:['IHasCupquake','Banana','Orange','Grape']}
  ]
};

const page3_qs = {
  type: jsPsychSurveyMultiChoice,
  questions: [
    {prompt: "AHHHH?", name:'q6', options:['This one','Cucumber','Eggplant','Corn']},
    {prompt: "RAAAA?", name:'q7', options:['Honk','Banana','Orange','Grape']}
  ]
};

const debrief = {
  type: jsPsychSurveyMultiChoice,
  preamble: `<h2>Debrief</h2>`,
  questions:[{prompt:"Thank you!", options:["Finish"], name:"end", required:true}]
};

// Wrap pages with logic
const page1_trial = addSurveyLogic(page1_qs);
const page2_trial = addSurveyLogic(page2_qs);
const page3_trial = addSurveyLogic(page3_qs);

const save_data = {
  type: jsPsychPipe,
  action: "save",
  experiment_id: "amoLpdRWNDSD",
  filename: filename,
  data_string: ()=>jsPsych.data.get().csv()
   };

// Timeline
const timeline = [intro, page1_trial, page2_trial, page3_trial, debrief, save_data];

jsPsych.run(timeline);

</script>
</html>
